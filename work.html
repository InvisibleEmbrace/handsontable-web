<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/handsontable.full.min.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/handsontable.full.min.js"></script>
    <script src="layer/layer.js"></script>
</head>
<body>
<div id="example"></div>

<script>
    var allData = [];
    var rows = [];
    var headers = ["1", "2", "3", "4", "5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"];
    var usersIdObject = {};

    $(function(){
        initData();
    });

    //加载初始化数据
    function initData() {
        $.get({
            url: 'http://localhost:8080/work/list',
            success: function (resp) {
                $.each(resp, function (index, item) {
                    var userId = item.id;
                    usersIdObject[index] = userId;
                    if (item.staffName && (rows.indexOf(item.staffName)>-1)) {
                        var x = rows.indexOf(item.staffName);
                        allData[x][item.day-1] = item.workFlagName;
                    }else {
                        rows.push(item.staffName);
                        var arr = [];
                        arr[item.day-1] = (item.workFlagName);
                        allData.push(arr);
                    }
                });
                console.log(allData);
                console.log(usersIdObject);
                console.log(rows);
                var container = document.getElementById('example');
                var hot = new Handsontable(container, {
                    data: allData,
                    rowHeaders: rows,
                    colHeaders: headers,
                    filters: true,
                    dropdownMenu: true,
                    columns: {length: 31},
                    afterChange: function (change, source) {
                        console.log(source);
                        if (source === 'loadData') {
                            return;
                        }else if (source === 'edit') {
                            var x = change[0][0];
                            var y = change[0][1];
                            var temp = change[0][3];
                            var userId = usersIdObject[x];
                            var prefix = userId.substring(0,userId.lastIndexOf("-") + 1);
                            var day = y + 1;
                            var id = prefix + day;
                            console.log("当前日期" + day);
                            console.log(id);
                                $.post({
                                    url: 'http://localhost:8080/work',
                                    data:{
                                        id: id,
                                        workFlagName:temp,
                                        day: day,
                                        staffName:rows[x]
                                    },
                                    success: function (resp) {
                                        allData[x][y] = resp.workFlagName;
                                        layer.msg('保存成功');
                                        hot.render();
                                    },
                                    error: function () {
                                        layer.msg('保存失败');
                                    }
                                });

                        }
                    }

                });
            }
        });
    }
</script>
</body>
</html>